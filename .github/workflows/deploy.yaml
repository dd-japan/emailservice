name: deploy to eks
on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
      - 'feature/**'
    paths
      - 'src/**' # srcディレクトリ以下のファイルに変更があった場合に実行
      - 'manifest/**'
      - .github/workflows/deploy.yaml
jobs:
  deploy-to-eks:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Kubectl tool installer
        uses: Azure/setup-kubectl@v3
      - name: Configure AWS Credentials For GitHub Actions
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: "arn:aws:iam::601427279990:role/dd-demo-eks-kihara-cluster-20240401070316771500000001"
          aws-region: us-east-1
      - name: Update KUBECONFIG
        run: aws eks update-kubeconfig --name dd-demo-eks-kihara
      - name: Deploy to EKS
        run: kubectl apply -f manifests/emailservice.yaml
